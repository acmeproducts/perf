<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Codex Checklist Console</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f6f7fb;
      --bg-dark: #131722;
      --panel: rgba(255, 255, 255, 0.92);
      --panel-dark: rgba(28, 32, 44, 0.9);
      --border: #d7d9e6;
      --border-dark: #2f3342;
      --muted: #5c6375;
      --muted-dark: #a0a7bb;
      --accent: #4361ee;
      --accent-soft: rgba(67, 97, 238, 0.18);
      --text: #1f2430;
      --text-dark: #f7f9ff;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, rgba(67, 97, 238, 0.12), transparent 340px) var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(180deg, rgba(122, 162, 255, 0.22), transparent 340px) var(--bg-dark);
        color: var(--text-dark);
      }
    }

    header {
      padding: 32px clamp(20px, 5vw, 56px) 16px;
    }

    header h1 {
      margin: 0 0 8px;
      font-size: clamp(1.6rem, 4vw, 2.5rem);
      letter-spacing: -0.02em;
    }

    header p {
      margin: 0;
      max-width: 720px;
      color: var(--muted);
      font-size: 1rem;
    }

    @media (prefers-color-scheme: dark) {
      header p {
        color: var(--muted-dark);
      }
    }

    main {
      flex: 1;
      padding: 0 clamp(20px, 5vw, 56px) 48px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tab-bar {
      display: flex;
      gap: 10px;
      border-bottom: 1px solid rgba(67, 97, 238, 0.15);
      flex-wrap: wrap;
    }

    .tab-button {
      position: relative;
      appearance: none;
      border: none;
      background: none;
      padding: 12px 20px;
      font: inherit;
      font-weight: 600;
      color: var(--muted);
      border-radius: 14px 14px 0 0;
      cursor: pointer;
      transition: color 0.18s ease, background 0.18s ease;
    }

    .tab-button.active {
      color: var(--accent);
      background: var(--panel);
      box-shadow: 0 -10px 30px rgba(19, 29, 60, 0.08);
    }

    .tab-panel {
      display: none;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 0 18px 18px 18px;
      box-shadow: 0 28px 48px rgba(19, 29, 60, 0.08);
      padding: 0;
      overflow: hidden;
    }

    .tab-panel.active {
      display: block;
    }

    .tab-panel iframe {
      display: block;
      width: 100%;
      height: min(78vh, 960px);
      min-height: 520px;
      border: none;
      background: transparent;
    }

    @media (prefers-color-scheme: dark) {
      .tab-button.active {
        background: var(--panel-dark);
        color: #c8d1ff;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.35);
      }

      .tab-panel {
        background: var(--panel-dark);
        border-color: var(--border-dark);
        box-shadow: 0 28px 48px rgba(0, 0, 0, 0.4);
      }
    }

    @media (max-width: 960px) {
      .tab-panel iframe {
        height: 70vh;
        min-height: 440px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Codex Checklist Console</h1>
    <p>Collect merged pull requests, curate review notes, and consume the same checklist from a unified viewer. Use the tabs below to switch between entry management and the presentation experience.</p>
  </header>
  <main>
    <nav class="tab-bar" role="tablist">
      <button id="tab-checklist" class="tab-button active" data-tab="checklist" role="tab" aria-selected="true" aria-controls="panel-checklist">Checklist Builder</button>
      <button id="tab-viewer" class="tab-button" data-tab="viewer" role="tab" aria-selected="false" aria-controls="panel-viewer">Reviewer View</button>
    </nav>
    <section class="tab-panel active" id="panel-checklist" role="tabpanel" aria-labelledby="tab-checklist">
      <iframe id="checklist-frame" src="view.html" title="Checklist builder"></iframe>
    </section>
    <section class="tab-panel" id="panel-viewer" role="tabpanel" aria-labelledby="tab-viewer">
      <iframe id="viewer-frame" src="viewer.html" title="Checklist viewer"></iframe>
    </section>
  </main>
  <script src="codex-checklist-shared.js"></script>
  <script>
    const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
    const panels = {
      checklist: document.getElementById('panel-checklist'),
      viewer: document.getElementById('panel-viewer')
    };

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.dataset.tab;
        if (!tab || !panels[tab]) return;
        tabButtons.forEach(btn => {
          const isActive = btn === button;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
        });
        Object.entries(panels).forEach(([key, panel]) => {
          panel.classList.toggle('active', key === tab);
        });
      });
    });

    const viewFrame = document.getElementById('checklist-frame');
    const viewerFrame = document.getElementById('viewer-frame');

    const readyState = {
      checklist: false,
      viewer: false,
      bootstrapped: false
    };

    function postToFrame(frame, detail) {
      if (!frame || !frame.contentWindow || !detail) return;
      try {
        frame.contentWindow.postMessage({
          type: 'codexrecall-checklist-updated',
          owner: detail.owner,
          repo: detail.repo,
          payload: detail.payload
        }, '*');
      } catch (error) {
        console.warn('Codex Checklist Console: unable to post update to frame', error);
      }
    }

    function hydrateFramesFromCurrent() {
      if (!window.CodexChecklist) return;
      const current = window.CodexChecklist.current || window.CodexChecklist.loadLatest();
      if (!current) return;
      window.CodexChecklist.setCurrent(current, { dispatchEvent: false, bubble: false });
      postToFrame(viewFrame, current);
      postToFrame(viewerFrame, current);
    }

    function tryBootstrap() {
      if (readyState.bootstrapped) return;
      if (readyState.checklist && readyState.viewer) {
        readyState.bootstrapped = true;
        hydrateFramesFromCurrent();
      }
    }

    viewFrame.addEventListener('load', () => {
      readyState.checklist = true;
      tryBootstrap();
    });

    viewerFrame.addEventListener('load', () => {
      readyState.viewer = true;
      tryBootstrap();
    });

    window.addEventListener('message', event => {
      const data = event && event.data;
      if (!data || data.type !== 'codexrecall-checklist-updated') return;
      if (!data.owner || !data.repo || !data.payload) return;
      const sourceWindow = event.source;
      const source = sourceWindow === viewFrame.contentWindow ? 'view' : sourceWindow === viewerFrame.contentWindow ? 'viewer' : 'external';
      if (window.CodexChecklist) {
        window.CodexChecklist.setCurrent({ owner: data.owner, repo: data.repo, payload: data.payload, source }, { dispatchEvent: false, bubble: false });
      }
      if (source !== 'view') {
        postToFrame(viewFrame, data);
      }
      if (source !== 'viewer') {
        postToFrame(viewerFrame, data);
      }
    });

    window.addEventListener('codexrecall:checklist-updated', event => {
      const detail = event.detail;
      if (!detail || !detail.payload) return;
      if (detail.source === 'view' || detail.source === 'viewer' || detail.source === 'message') return;
      postToFrame(viewFrame, detail);
      postToFrame(viewerFrame, detail);
    });
  </script>
</body>
</html>
