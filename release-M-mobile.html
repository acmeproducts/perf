
<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <title>Release M — Mobile First (Event-Driven, 3‑Tier)</title>
    <style>
      :root{
        --bg:#0b0e12;--panel:#111622;--muted:#8b98a5;--text:#e7edf3;--accent:#4ea1ff;--ok:#2ecc71;--warn:#f39c12;--err:#e74c3c;
        --glass:rgba(255,255,255,.06);--glass-2:rgba(255,255,255,.12);--shadow:0 6px 30px rgba(0,0,0,.35);
        --radius:16px;--radius-sm:12px;
        --bottom-safe: env(safe-area-inset-bottom, 0px);
      }
      *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
      html,body{height:100%}
      body{margin:0;background:linear-gradient(180deg,#0b0e12,#0f1520);color:var(--text);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
      .app{display:flex;flex-direction:column;height:100dvh}
      .header{position:sticky;top:0;z-index:10;background:rgba(15,20,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--glass-2)}
      .header .row{display:flex;gap:10px;align-items:center;padding:10px 12px}
      .input{flex:1;background:#0b111b;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:12px 14px;border-radius:12px;font-size:16px}
      select.input{padding-right:34px}
      .main{flex:1;overflow:auto;padding:12px}
      .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
      .card{position:relative;border-radius:14px;overflow:hidden;background:#0f131a;border:1px solid rgba(255,255,255,.08)}
      .thumb{display:block;width:100%;aspect-ratio:1/1;object-fit:cover;background:#0a0f18}
      .meta{padding:8px 10px;color:#c9d5e1;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:8px}
      .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(78,161,255,.15);border:1px solid rgba(78,161,255,.3);color:#cfe5ff}
      .sel{position:absolute;left:8px;top:8px;width:26px;height:26px;border-radius:8px;border:2px solid rgba(255,255,255,.6);background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;opacity:.9}
      .sel.on{border-color:#58c964;background:rgba(46,204,113,.2)}
      .toast{position:fixed;right:12px;bottom:88px;display:flex;flex-direction:column;gap:8px;z-index:50}
      .toast .item{background:rgba(20,24,32,.95);border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:12px;min-width:240px}
      .hud{position:fixed;left:12px;bottom:88px;background:rgba(20,24,32,.95);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:12px;font-size:12px;z-index:40;max-width:420px;display:none}
      .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;color:#b2c1d1}
      .bottom{position:sticky;bottom:0;z-index:12;background:rgba(15,20,32,.96);backdrop-filter:blur(10px);border-top:1px solid var(--glass-2)}
      .bar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px 12px;padding-bottom:calc(10px + var(--bottom-safe));}
      .btn{display:flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(180deg,#1a2231,#121a28);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:12px;border-radius:14px;font-size:15px}
      .btn:active{transform:scale(.98)}
      .count{font-weight:700;margin-left:6px}
      .muted{color:var(--muted)}
      .err{position:fixed;left:12px;top:12px;right:12px;display:none;z-index:9999}
      .err .box{background:#2b0e13;border:1px solid #c0392b;color:#ffecec;padding:12px;border-radius:12px;white-space:pre-wrap}
    </style>
  </head>
  <body>
    <div class="app">
      <div id="err" class="err"><div class="box"></div></div>
      <div class="header">
        <div class="row">
          <input id="q" class="input" placeholder="Search (terms, #tag, -exclude)" inputmode="search" />
          <select id="sort" class="input" style="max-width:180px">
            <option value="name|asc">Name ↑</option>
            <option value="name|desc">Name ↓</option>
            <option value="modifiedTime|desc">Modified ↑</option>
            <option value="modifiedTime|asc">Modified ↓</option>
          </select>
        </div>
      </div>
      <div id="main" class="main">
        <div id="grid" class="grid"></div>
      </div>
      <div class="toast" id="toast"></div>
      <div class="hud" id="hud"></div>
      <div class="bottom">
        <div class="bar">
          <button id="btnTag" class="btn" aria-label="Tag favorite">★ Tag</button>
          <button id="btnMove" class="btn" aria-label="Move to archive">⇢ Archive</button>
          <button id="btnHUD" class="btn" aria-label="Toggle HUD">HUD</button>
          <button id="btnSync" class="btn" aria-label="Sync now">⟳ Sync</button>
        </div>
      </div>
    </div>
    <script>
      // ===== Error overlay =====
      const Err = (()=>{const w=document.getElementById('err'),b=w.querySelector('.box');
        function show(m){b.textContent=m;w.style.display='block';console.error(m);}
        window.addEventListener('error',e=>show('JS Error: '+(e.error?.stack||e.message)));
        window.addEventListener('unhandledrejection',e=>show('Promise Rejection: '+(e.reason?.stack||e.reason)));
        return { show };
      })();

      // ===== Utilities =====
      const Utils = {
        id: () => Math.random().toString(36).slice(2),
        debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; },
        gdriveThumb: (id,w=320)=>`https://drive.google.com/thumbnail?id=${encodeURIComponent(id)}&sz=w${w}`,
        gdriveView: (id)=>`https://drive.google.com/uc?export=view&id=${encodeURIComponent(id)}`,
      };

      // ===== Toasts & HUD =====
      const Toast = { show(m){ const r=document.getElementById('toast'); const d=document.createElement('div'); d.className='item'; d.textContent=m; r.appendChild(d); setTimeout(()=>d.remove(),2600); } };
      const HUD = (()=>{ const el=document.getElementById('hud'); let st={}, vis=false;
        function render(){ el.innerHTML =
          `<div style="font-weight:600;margin-bottom:6px">Trace HUD</div>
           <div class="kv">
             <div>Queue size</div><div>${st.queueSize||0}</div>
             <div>Last action</div><div>${st.lastAction||'-'}</div>
             <div>Last provider</div><div class="muted">${st.lastProvider||'-'}</div>
             <div>Cache keys</div><div>${st.cacheKeys||0}</div>
             <div>changes_made</div><div class="muted">${st.changes_made? new Date(st.changes_made).toLocaleString(): '-'}</div>
           </div>`; }
        return { toggle(){ vis=!vis; el.style.display=vis?'block':'none'; render(); }, update(s){ st={...st,...s}; if(vis) render(); } };
      })();

      // ===== DB (IndexedDB with localStorage fallback) =====
      const DB = (()=>{
        const NAME='goji-db-m'; const STORES=['folders','metadata','sync_queue','settings'];
        let db, fallback=null;
        const lsKey=s=>`dbshim.${NAME}.${s}`;
        const ensure=s=>{ const k=lsKey(s); if(localStorage.getItem(k)==null) localStorage.setItem(k, JSON.stringify({})); };
        async function open(){
          try{
            await new Promise((res,rej)=>{
              const req=indexedDB.open(NAME,1);
              req.onupgradeneeded=()=>{ const d=req.result; STORES.forEach(s=>{ if(!d.objectStoreNames.contains(s)) d.createObjectStore(s); }); };
              req.onsuccess=()=>{ db=req.result; res(); };
              req.onerror=()=>rej(req.error);
            });
          }catch(e){ fallback=true; STORES.forEach(ensure); console.warn('IndexedDB unavailable; using localStorage shim.', e); }
        }
        function get(s,k){ if(fallback){ const blob=JSON.parse(localStorage.getItem(lsKey(s))||'{}'); return Promise.resolve(blob[k]); }
          return new Promise((res,rej)=>{ const tx=db.transaction(s,'readonly'); const os=tx.objectStore(s); const rq=os.get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }); }
        function put(s,k,v){ if(fallback){ const K=lsKey(s); const blob=JSON.parse(localStorage.getItem(K)||'{}'); blob[k]=v; localStorage.setItem(K, JSON.stringify(blob)); return Promise.resolve(); }
          return new Promise((res,rej)=>{ const tx=db.transaction(s,'readwrite'); const os=tx.objectStore(s); const rq=os.put(v,k); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error); }); }
        function del(s,k){ if(fallback){ const K=lsKey(s); const blob=JSON.parse(localStorage.getItem(K)||'{}'); delete blob[k]; localStorage.setItem(K, JSON.stringify(blob)); return Promise.resolve(); }
          return new Promise((res,rej)=>{ const tx=db.transaction(s,'readwrite'); const os=tx.objectStore(s); const rq=os.delete(k); rq.onsuccess=()=>res(); rq.onerror=()=>rej(rq.error); }); }
        function keys(s){ if(fallback){ const blob=JSON.parse(localStorage.getItem(lsKey(s))||'{}'); return Promise.resolve(Object.keys(blob)); }
          return new Promise((res,rej)=>{ const tx=db.transaction(s,'readonly'); const os=tx.objectStore(s); const rq=os.getAllKeys(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error); }); }
        async function scan(s,map=(_,v)=>v){ const ks=await keys(s); const out=[]; for(const k of ks){ const v=await get(s,k); out.push(map(k,v)); } return out; }
        return { open, get, put, del, keys, scan };
      })();

      // ===== Provider (Demo) =====
      const Providers = (()=>{
        function Demo(){
          const KEY='demo-cloud';
          const load=()=>JSON.parse(localStorage.getItem(KEY)||'{}');
          const save=x=>localStorage.setItem(KEY, JSON.stringify(x));
          return {
            name:'Demo',
            async list(folder='root'){ const c=load(); return Object.values(c[folder]||{}).map(x=>({...x})); },
            async patchMeta(id, patch){ const c=load(); for(const f in c){ if(c[f][id]){ c[f][id]={...c[f][id], ...patch, modifiedTime:Date.now()}; save(c); return true; } } return false; },
            async move(id, dest){ const c=load(); for(const f in c){ if(c[f][id]){ c[f][id]={...c[f][id], stack:dest, modifiedTime:Date.now()}; save(c); return true; } } return false; },
          };
        }
        return { Demo };
      })();

      // ===== Queue =====
      const Queue = (()=>{
        const EV='queue:changed';
        async function mark(){ const now=Date.now(); await DB.put('settings','changes_made', now); HUD.update({changes_made: now}); window.dispatchEvent(new CustomEvent(EV)); }
        async function enqueue(item){ const id=item.id||Math.random().toString(36).slice(2); await DB.put('sync_queue', id, {...item, id, ts:item.ts||Date.now()}); await mark(); return id; }
        async function readNext(n=50){ const all=await DB.scan('sync_queue',(k,v)=>v); all.sort((a,b)=>a.ts-b.ts); return all.slice(0,n); }
        async function ack(ids){ for(const id of ids) await DB.del('sync_queue', id); await mark(); }
        return { enqueue, readNext, ack, EV };
      })();

      // ===== Core =====
      const Core = (()=>{
        const st={ provider:null, folder:'root', files:[], sort:{by:'name',dir:'asc'}, selection:new Set(), settings:{demo:true} };
        const ls=new Set();
        function emit(){ ls.forEach(fn=>fn(getState())); }
        function getState(){ return JSON.parse(JSON.stringify({...st, selection:[...st.selection]})); }
        async function init(provider){ await DB.open(); st.provider=provider; await seed(); await fromCacheThenCloud(); emit(); }
        async function seed(){
          if(!st.settings.demo) return;
          const have=await DB.get('folders', st.folder);
          if(!have){
            const seed=Array.from({length:20},(_,i)=>({ id:'demo-'+i, name:'Photo_'+String(i).padStart(3,'0')+'.jpg', size:200000+i*1337, tags:i%3?[]:['favorite'], modifiedTime: Date.now()-i*100000 }));
            await DB.put('folders', st.folder, seed);
            let cloud=JSON.parse(localStorage.getItem('demo-cloud')||'{}'); cloud[st.folder]=cloud[st.folder]||{};
            for(const f of seed){ cloud[st.folder][f.id]=f; }
            localStorage.setItem('demo-cloud', JSON.stringify(cloud));
          }
        }
        function sortFiles(a){ const {by,dir}=st.sort; const s=[...a].sort((x,y)=>{ let A=x[by], B=y[by]; if(by==='name'){ A=String(A).toLowerCase(); B=String(B).toLowerCase(); } if(by==='modifiedTime'){ A=+A; B=+B; } return A<B?-1:A>B?1:0; }); return dir==='asc'?s:s.reverse(); }
        async function fromCacheThenCloud(){ const cached=await DB.get('folders', st.folder)||[]; st.files=sortFiles(cached); emit(); refreshCloudInBackground().catch(e=>Toast.show('Cloud refresh error: '+e.message)); }
        async function refreshCloudInBackground(){
          const prov=st.provider; let cloudList=[];
          if(prov && prov.name==='Demo') cloudList = await prov.list(st.folder);
          const cache=await DB.get('folders', st.folder)||[]; const byId=Object.fromEntries(cache.map(f=>[f.id,f]));
          for(const remote of cloudList){ const local=byId[remote.id]; if(!local || (remote.modifiedTime && remote.modifiedTime>(local.modifiedTime||0))) byId[remote.id]={...local,...remote}; }
          const merged=Object.values(byId); await DB.put('folders', st.folder, merged); st.files=sortFiles(merged); emit();
        }
        function on(fn){ ls.add(fn); return ()=>ls.delete(fn); }
        function setSort(by,dir){ st.sort={by,dir}; st.files=sortFiles(st.files); emit(); }
        function toggleSelect(id){ if(st.selection.has(id)) st.selection.delete(id); else st.selection.add(id); emit(); }
        function clearSelection(){ st.selection.clear(); emit(); }
        async function tagSelected(){ const ids=[...st.selection]; if(!ids.length) return; const files=await DB.get('folders', st.folder)||[]; const map=Object.fromEntries(files.map(f=>[f.id,f])); for(const id of ids){ const cur=new Set(map[id]?.tags||[]); cur.add('favorite'); map[id]={...map[id], tags:[...cur]}; await Queue.enqueue({op:'patchMeta', id, payload:{tags:[...cur]}}); } await DB.put('folders', st.folder, Object.values(map)); st.files=sortFiles(Object.values(map)); emit(); HUD.update({lastAction:`tag:${ids.length}`}); }
        async function moveSelected(dest='archive'){ const ids=[...st.selection]; if(!ids.length) return; for(const id of ids) await Queue.enqueue({op:'move', id, payload:{dest}}); Toast.show('Queued move → '+dest); HUD.update({lastAction:`move:${ids.length}`}); }
        async function search(q){
          const t=String(q||'').trim().split(/\s+/).filter(Boolean);
          const must=t.filter(x=>!x.startsWith('#')&&!x.startsWith('-'));
          const tags=t.filter(x=>x.startsWith('#')).map(x=>x.slice(1));
          const not=new Set(t.filter(x=>x.startsWith('-')).map(x=>x.slice(1).toLowerCase()));
          const all=await DB.get('folders', st.folder)||[];
          const res=all.filter(f=>{ const n=(f.name||'').toLowerCase();
            if(must.length && !must.every(w=>n.includes(w.toLowerCase()))) return false;
            if(tags.length && !tags.every(w=>(f.tags||[]).includes(w))) return false;
            if([...not].some(w=>n.includes(w))) return false; return true; });
          st.files=sortFiles(res); emit();
        }
        return { init, on, getState, setSort, toggleSelect, clearSelection, tagSelected, moveSelected, search, refreshCloudInBackground };
      })();

      // ===== Worker (event-driven, debounced) =====
      const WorkerLoop = (()=>{
        const prov=Providers.Demo();
        const debounced = Utils.debounce(drain, 800);
        let running=false;
        async function drain(){
          if(running) return; running=true;
          try{
            const batch=await Queue.readNext(50);
            HUD.update({queueSize: batch.length});
            if(batch.length===0) return;
            for(const it of batch){
              if(it.op==='patchMeta') await prov.patchMeta(it.id, it.payload);
              if(it.op==='move') await prov.move(it.id, it.payload.dest);
            }
            await Queue.ack(batch.map(x=>x.id));
            HUD.update({queueSize:0, lastProvider:prov.name});
            await Core.refreshCloudInBackground();
          }catch(e){ Toast.show('Worker error: '+e.message); }
          finally{ running=false; }
        }
        function start(){
          drain();
          window.addEventListener('online', debounced);
          window.addEventListener('visibilitychange', ()=>{ if(!document.hidden) debounced(); });
          window.addEventListener(Queue.EV, debounced);
        }
        return { start, drain };
      })();

      // ===== Mobile UI =====
      const UI = (()=>{
        const grid=document.getElementById('grid');
        const q=document.getElementById('q');
        const sortSel=document.getElementById('sort');

        function render(files, selection){
          grid.innerHTML='';
          for(const f of files){
            const card=document.createElement('div'); card.className='card'; card.dataset.id=f.id;
            const img=document.createElement('img'); img.className='thumb'; img.alt=f.name; img.src=Utils.gdriveThumb(f.id, 480);
            const sel=document.createElement('div'); sel.className='sel'+(selection.includes(f.id)?' on':'' ); sel.textContent = selection.includes(f.id)?'✓':'';
            const meta=document.createElement('div'); meta.className='meta';
            const name=document.createElement('div'); name.textContent=f.name;
            const pill=document.createElement('span'); pill.className='pill'; pill.textContent=(f.tags||[]).includes('favorite')?'★ favorite':'file';
            meta.append(name,pill);
            card.append(img, sel, meta);
            // Tap to toggle selection
            card.addEventListener('click', (e)=>{ e.preventDefault(); Core.toggleSelect(f.id); });
            // Long-press = select + keep selecting
            let pressT=null;
            card.addEventListener('touchstart', ()=>{ pressT=setTimeout(()=>Core.toggleSelect(f.id), 350); }, {passive:true});
            card.addEventListener('touchend', ()=>{ if(pressT){ clearTimeout(pressT); pressT=null; } }, {passive:true});
            grid.append(card);
          }
        }

        Core.on(async s=>{
          render(s.files, s.selection||[]);
          HUD.update({lastAction:'render', cacheKeys:(await DB.keys('folders')).length});
          document.title = `Release M — ${s.selection?.length||0} selected`;
          document.getElementById('btnTag').disabled = (s.selection||[]).length===0;
          document.getElementById('btnMove').disabled = (s.selection||[]).length===0;
        });

        // Controls
        q.addEventListener('input', e=>Core.search(e.target.value));
        sortSel.addEventListener('change', e=>{ const [by,dir]=e.target.value.split('|'); Core.setSort(by,dir); });

        // Bottom bar
        document.getElementById('btnTag').onclick = ()=>Core.tagSelected().then(()=>Toast.show('Tagged favorite'));
        document.getElementById('btnMove').onclick = ()=>Core.moveSelected('archive');
        document.getElementById('btnHUD').onclick = ()=>HUD.toggle();
        document.getElementById('btnSync').onclick = ()=>WorkerLoop.drain(); // manual kick

        return { render };
      })();

      // ===== Boot =====
      (async function start(){
        try{
          await DB.open();
          await Core.init(Providers.Demo());
          WorkerLoop.start();
          Toast.show('Release M — Mobile ready');
        }catch(e){ Err.show('Startup failed: '+(e.stack||e.message)); }
      })();
    </script>
  </body>
</html>
