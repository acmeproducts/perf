# ui-v5 Refactor and Feature Implementation Plan

This document expands the previously agreed plan into a detailed, checkable task list so the work can be executed step by step. Each task is written as a checkbox item so it can be marked complete as work progresses.

## 1. Remove Coordinators, Probes, and Offline Mutation Logic

### 1.1 Inventory and Preparation
- [ ] Audit `ui-v5.html` for all global state fields, classes, and helpers related to sync or coordination (`state.folderSyncCoordinator`, `state.syncManager`, manifest helpers, offline queues).
- [ ] Comment all discovered sections in a scratchpad (outside the repo) to ensure nothing critical to straight cloud reads is accidentally removed.

### 1.2 Eliminate Coordinator/Sync Classes
- [ ] Delete the `FolderSyncCoordinator` class definition and its exports/imports.
- [ ] Delete the `SyncManager` class definition and its exports/imports.
- [ ] Remove any instantiation or references to the deleted classes inside initialization flows.

### 1.3 Simplify IndexedDB Usage
- [ ] Remove IndexedDB stores/tables dedicated to manifests, sync queues, and cached folder payloads.
- [ ] Retain or refactor only the minimal metadata store needed for per-file information and forthcoming timestamps.
- [ ] Delete helper functions such as `loadFolderManifest`, `saveFolderManifest`, and similar version bookkeeping utilities.

### 1.4 Streamline Folder Loading
- [ ] Replace cached/merge/background refresh flows (`mergeCloudWithCache`, `syncFolderFromCloud`, `refreshFolderInBackground`, visit tracking) with a single cloud fetch executed each time a folder is opened.
- [ ] Ensure folder rendering uses only the immediate cloud response with no post-render adjustments.

## 2. Custom Timestamp Design and Synchronization

### 2.1 Folder-Level `lastUpdated`
- [ ] Introduce a lightweight folder metadata record in RAM, IndexedDB, and cloud (e.g., hidden JSON/appProperty) that stores `lastUpdated` as a numeric epoch generated by our code.
- [ ] Build a `FolderTimestampService` to read RAM and IndexedDB values, fetch the cloud marker, and reconcile the freshest timestamp without repainting the current UI.
- [ ] Update folder mutation flows to set `Date.now()` immediately in RAM, persist the IndexedDB record, and push the cloud marker in the same call chain (retry once on failure, inline).

### 2.2 File-Level `lastUpdated`
- [ ] Extend file objects in RAM to include `lastUpdated` sourced from our metadata (default `0` when absent).
- [ ] Expand IndexedDB records with the same field and add helpers for batch retrieval (`getManyMetadata`).
- [ ] Modify provider load routines to read/write our custom timestamps (Google `appProperties`, OneDrive JSON metadata, etc.).
- [ ] Update all metadata mutation paths (user edits, background extraction, drag reorder) to stamp a new `lastUpdated`, push to the provider immediately, and then persist to IndexedDB.

## 3. Drag-and-Drop in Grid Mode (Goji Parity)

### 3.1 Styling and Markup
- [ ] Import/replicate Goji `.grid-drag-handle`, `.grid-item.dragging`, and drop-target CSS rules into `ui-v5.html` without altering layout dimensions.
- [ ] Append a drag handle button to each grid tile template while maintaining existing click/select behavior.

### 3.2 Interaction Logic
- [ ] Port Goji drag session helpers (`startDrag`, `handlePointerMove`, `handlePointerRelease`, `setDropTarget`, cleanup) and adapt them to the simplified metadata update pipeline (no `persistGroupDropOrder`).
- [ ] Ensure reordering updates the in-memory stack array, stamps new sequence/timestamps, writes to the provider, and persists to IndexedDB inline.
- [ ] Preserve Goji keyboard/ARIA semantics to maintain accessibility.

## 4. Folder Selection Performance via Timestamps

### 4.1 Immediate Rendering without Post-Render Changes
- [ ] Modify folder selection rendering to use RAM/IndexedDB snapshots immediately when the screen opens.
- [ ] Guarantee that no UI repaint occurs after cloud validation; instead, apply any fresher cloud data to state only for the next navigation.

### 4.2 Efficient Refresh Logic
- [ ] Cache per-folder summaries (counts, `lastUpdated`) in the new folder metadata store.
- [ ] Use the cloud marker to decide whether a summary is stale before initiating an expensive rescan.
- [ ] Update provider folder listing calls to include our marker lookup so comparisons remain lightweight.
- [ ] Ensure navigation back from a folder writes the updated timestamp and summary before the folder list is shown, keeping the display responsive without rescans.

## 5. Preserve Existing UI for Provider/Auth/Folder Screens
- [ ] Confirm that no markup or visible styles for provider selection, authentication, or folder list screens are altered by the refactor.
- [ ] Run a manual visual verification after changes to ensure these screens remain identical except for the newly approved drag-and-drop handles in grid view.

## 6. Validation and Cleanup
- [ ] Run existing automated tests or lint steps defined for the project.
- [ ] Manually exercise key flows: provider login, folder selection, grid drag-and-drop, metadata update, and timestamp reconciliation.
- [ ] Remove any dead code or leftover references uncovered during testing.
- [ ] Document the new timestamp storage locations and update any developer notes if required.

